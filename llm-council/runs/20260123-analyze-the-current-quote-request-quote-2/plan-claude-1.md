{"type":"result","subtype":"success","is_error":false,"duration_ms":104647,"duration_api_ms":115761,"num_turns":1,"result":"# Plan\n\n## Overview\nExtend the existing quote request flow to include customer-facing quote status/acceptance, admin prioritization queue, email/Slack notifications at key lifecycle stages, pricing breakdowns, and tracking metrics. Uses tokenized URLs for secure public access with audit trails.\n\n## Scope\n- In:\n  - Database schema changes for quote lifecycle, tokens, pricing breakdowns, metrics\n  - Customer-facing status page with secure token access\n  - Quote acceptance/rejection flow with digital signature\n  - Admin queue with prioritization, filtering, SLA indicators\n  - Email notifications (quote received, quote ready, accepted/rejected, expiration warnings)\n  - Slack notifications for high-priority quotes and SLA breaches\n  - Pricing breakdown storage and display\n  - Basic analytics/metrics tracking\n  - Audit trail for all quote state changes\n\n- Out:\n  - Payment processing integration\n  - PortPro TMS quote sync (future work)\n  - Customer portal quote history (existing dashboard scope)\n  - Automated pricing calculation engine\n  - PDF quote generation (can be Phase 4)\n\n## Phases\n\n### Phase 1: Schema & Token Infrastructure\n**Goal**: Establish database foundation for quote lifecycle, secure tokens, and audit trail.\n\n#### Task 1.1: Quote Lifecycle Schema Migration\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\n- Description: Add quote status enum, pricing breakdown JSONB, expiration fields, and acceptance fields to quotes table.\n- Estimated Tokens: 800\n- Dependencies: None\n- Steps:\n  - Create enum `quote_status` with values: `pending`, `in_review`, `quoted`, `accepted`, `rejected`, `expired`, `cancelled`\n  - Add columns: `status quote_status DEFAULT 'pending'`, `quoted_at timestamptz`, `expires_at timestamptz`, `accepted_at timestamptz`, `rejected_at timestamptz`, `rejection_reason text`, `pricing_breakdown jsonb`, `total_price numeric(10,2)`, `validity_days int DEFAULT 7`\n  - Add index on `status` and `created_at` for queue queries\n  - Backfill existing quotes to `pending` or `quoted` based on presence of pricing data\n- Acceptance Criteria:\n  - Migration runs without error on existing data\n  - Existing quotes retain all current data\n  - New status column queryable\n\n#### Task 1.2: Quote Token Table\n- Location: `supabase/migrations/016_quote_lifecycle.sql` (same migration)\n- Description: Create secure token table for public quote access links.\n- Estimated Tokens: 600\n- Dependencies: Task 1.1\n- Steps:\n  - Create table `quote_tokens` with: `id uuid PK`, `quote_id uuid FK NOT NULL`, `token varchar(64) UNIQUE NOT NULL`, `type enum('status', 'accept')`, `expires_at timestamptz NOT NULL`, `used_at timestamptz`, `created_at timestamptz DEFAULT now()`\n  - Add RLS policy: tokens readable only via exact token match (no user auth required for public access)\n  - Create function `generate_quote_token(quote_id, type, validity_hours)` returning token string\n  - Index on `token` for fast lookup\n- Acceptance Criteria:\n  - Tokens can be generated and retrieved by exact match\n  - RLS prevents enumeration attacks\n  - Expired tokens return no results\n\n#### Task 1.3: Quote Audit Trail Table\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\n- Description: Track all quote state changes for compliance and debugging.\n- Estimated Tokens: 500\n- Dependencies: Task 1.1\n- Steps:\n  - Create table `quote_audit_log` with: `id uuid PK`, `quote_id uuid FK NOT NULL`, `action varchar(50) NOT NULL`, `old_status quote_status`, `new_status quote_status`, `actor_id uuid` (nullable for system/customer actions), `actor_type enum('system', 'admin', 'customer')`, `metadata jsonb`, `ip_address inet`, `created_at timestamptz DEFAULT now()`\n  - Create trigger function to auto-log status changes on quotes table\n  - No RLS (admin-only access via service role)\n- Acceptance Criteria:\n  - Every status change creates audit record automatically\n  - Manual audit entries can be created via insert\n  - IP address captured when available\n\n#### Task 1.4: Update TypeScript Types\n- Location: `types/database.ts`\n- Description: Regenerate or manually update types to include new schema.\n- Estimated Tokens: 400\n- Dependencies: Tasks 1.1-1.3\n- Steps:\n  - Run `supabase gen types typescript` or manually add types\n  - Add `QuoteStatus` type union\n  - Add `QuoteToken`, `QuoteAuditLog` interfaces\n  - Update `Quote` interface with new fields\n- Acceptance Criteria:\n  - TypeScript compilation passes\n  - New fields accessible with proper types\n\n### Phase 2: Admin Queue & Prioritization\n**Goal**: Replace flat admin list with prioritized, filterable queue with SLA indicators.\n\n#### Task 2.1: Quote Priority Scoring\n- Location: `lib/quotes/priority.ts` (new)\n- Description: Implement priority calculation based on lead score, age, value, and SLA.\n- Estimated Tokens: 600\n- Dependencies: Phase 1\n- Steps:\n  - Create function `calculateQuotePriority(quote)` returning score 0-100\n  - Factors: lead_score (from 015 migration), hours since created, estimated value, customer tier\n  - Define SLA thresholds: respond within 4h (high), 8h (medium), 24h (low)\n  - Export `getSLAStatus(quote)` returning `overdue | warning | ok`\n- Acceptance Criteria:\n  - Priority scores deterministic for same inputs\n  - SLA status correctly reflects time thresholds\n\n#### Task 2.2: Admin Queue API Endpoint\n- Location: `app/api/admin/quotes/route.ts` (modify existing or create)\n- Description: Add filtering, sorting, pagination for admin queue.\n- Estimated Tokens: 800\n- Dependencies: Task 2.1\n- Steps:\n  - Accept query params: `status`, `priority_min`, `sla_status`, `sort_by`, `sort_order`, `page`, `limit`\n  - Join with organization for customer context\n  - Calculate priority score in-memory or via computed column\n  - Return paginated results with total count\n  - Add `assignee_id` filter for \"my quotes\" view\n- Acceptance Criteria:\n  - Filters work independently and combined\n  - Pagination returns correct totals\n  - Response time <500ms for typical queries\n\n#### Task 2.3: Admin Queue UI\n- Location: `app/admin/quotes/page.tsx`, `components/admin/quote-queue.tsx` (new)\n- Description: Build prioritized queue interface with filters and SLA badges.\n- Estimated Tokens: 1200\n- Dependencies: Task 2.2\n- Steps:\n  - Create `QuoteQueue` component with table/card view toggle\n  - Add filter bar: status dropdown, SLA status, search by company/email\n  - Display priority score, SLA badge (green/yellow/red), time since created\n  - Add bulk actions: assign to me, mark in review\n  - Implement keyboard navigation for power users\n  - Add \"claim\" button to self-assign quotes\n- Acceptance Criteria:\n  - Overdue quotes visually prominent (red indicator)\n  - Filters persist in URL for bookmarking\n  - Real-time updates via polling or Supabase realtime\n\n#### Task 2.4: Quote Assignment System\n- Location: `supabase/migrations/017_quote_assignment.sql`, `app/api/admin/quotes/[id]/assign/route.ts`\n- Description: Allow admins to claim/assign quotes.\n- Estimated Tokens: 600\n- Dependencies: Task 2.3\n- Steps:\n  - Add `assignee_id uuid FK profiles`, `assigned_at timestamptz` to quotes\n  - Create API endpoint for assignment with audit logging\n  - Update queue to show assignee avatar/name\n  - Add \"unassigned\" filter option\n- Acceptance Criteria:\n  - Only one assignee per quote\n  - Assignment creates audit log entry\n  - Reassignment allowed with reason\n\n### Phase 3: Customer Status & Acceptance Flow\n**Goal**: Enable customers to view quote status and accept/reject via secure tokenized links.\n\n#### Task 3.1: Token Generation Service\n- Location: `lib/quotes/tokens.ts` (new)\n- Description: Create/validate/expire quote access tokens.\n- Estimated Tokens: 500\n- Dependencies: Phase 1\n- Steps:\n  - `createStatusToken(quoteId)` → 32-char random token, 30-day expiry\n  - `createAcceptToken(quoteId)` → 32-char token, expires with quote validity\n  - `validateToken(token, type)` → returns quote or null\n  - `revokeToken(tokenId)` for invalidation\n  - Use crypto.randomBytes for token generation\n- Acceptance Criteria:\n  - Tokens cryptographically random\n  - Expired tokens return null\n  - Used accept tokens cannot be reused\n\n#### Task 3.2: Public Quote Status Page\n- Location: `app/quote/status/[token]/page.tsx` (new)\n- Description: Customer-facing quote status view.\n- Estimated Tokens: 1000\n- Dependencies: Task 3.1\n- Steps:\n  - Server component fetching quote via token\n  - Display: status badge, pricing breakdown (if quoted), validity countdown, company info (redacted email)\n  - Show timeline of status changes (from audit log, sanitized)\n  - If status=quoted: show accept/reject buttons linking to accept page\n  - If expired: show \"request new quote\" CTA\n  - No authentication required; token is auth\n- Acceptance Criteria:\n  - Invalid token shows 404-style message (not \"invalid token\" to prevent enumeration)\n  - No sensitive internal data exposed (no admin notes, lead scores)\n  - Mobile responsive\n\n#### Task 3.3: Quote Acceptance Page\n- Location: `app/quote/accept/[token]/page.tsx` (new)\n- Description: Form for customer to accept or reject quote with confirmation.\n- Estimated Tokens: 1000\n- Dependencies: Task 3.2\n- Steps:\n  - Validate accept-type token\n  - Display quote summary and pricing breakdown\n  - Accept flow: checkbox for terms, digital signature (typed name + timestamp), submit\n  - Reject flow: optional reason dropdown + text, submit\n  - POST to `/api/quote/accept` with token\n  - Success page with next steps (expect email, booking process)\n- Acceptance Criteria:\n  - Cannot accept expired quote\n  - Acceptance requires explicit checkbox + name\n  - Rejection reason stored in quote record\n\n#### Task 3.4: Quote Accept/Reject API\n- Location: `app/api/quote/accept/route.ts` (new)\n- Description: Process customer acceptance or rejection.\n- Estimated Tokens: 700\n- Dependencies: Task 3.3\n- Steps:\n  - Validate token, check quote status=quoted and not expired\n  - For accept: update status=accepted, accepted_at=now(), store signature data in metadata, mark token used\n  - For reject: update status=rejected, rejection_reason, rejected_at\n  - Create audit log entry with customer actor_type\n  - Trigger notifications (Phase 4)\n  - Return success with confirmation number\n- Acceptance Criteria:\n  - Race condition safe (use transaction)\n  - Audit log captures IP address\n  - Idempotent: re-accept returns existing confirmation\n\n### Phase 4: Notifications & Pricing\n**Goal**: Implement email/Slack notifications and pricing breakdown display.\n\n#### Task 4.1: Email Templates\n- Location: `lib/emails/templates/` (new directory), using Resend\n- Description: Create email templates for quote lifecycle.\n- Estimated Tokens: 1000\n- Dependencies: Phase 3\n- Steps:\n  - `quote-received.tsx`: confirmation with tracking link (status token URL)\n  - `quote-ready.tsx`: pricing summary, accept link (accept token URL), validity period\n  - `quote-accepted.tsx`: confirmation, next steps\n  - `quote-expiring.tsx`: 24h warning with accept link\n  - `quote-expired.tsx`: invite to request new quote\n  - Use React Email for templating, consistent branding\n- Acceptance Criteria:\n  - All emails mobile responsive\n  - Links use NEXT_PUBLIC_SITE_URL for correct domain\n  - Unsubscribe not needed (transactional)\n\n#### Task 4.2: Email Notification Service\n- Location: `lib/notifications/email.ts` (new)\n- Description: Centralized email sending with template selection.\n- Estimated Tokens: 600\n- Dependencies: Task 4.1\n- Steps:\n  - `sendQuoteEmail(type, quote, tokens)` → sends appropriate template via Resend\n  - Log email sends to audit log\n  - Handle Resend errors gracefully with retry logic\n  - Rate limit: max 3 emails per quote per hour (prevent loops)\n- Acceptance Criteria:\n  - Failed sends logged but don't crash\n  - Audit trail includes email send events\n\n#### Task 4.3: Slack Notification Updates\n- Location: `lib/notifications/slack.ts` (modify existing or new)\n- Description: Enhanced Slack alerts for admin queue.\n- Estimated Tokens: 500\n- Dependencies: Phase 2\n- Steps:\n  - Alert on: new high-priority quote, SLA breach (quote pending >4h), quote accepted\n  - Include deep link to admin quote detail\n  - Format with blocks: priority badge, customer info, quick action buttons\n  - Respect existing Slack webhook configuration\n- Acceptance Criteria:\n  - Slack alerts only if webhook configured\n  - No duplicate alerts for same event\n\n#### Task 4.4: Pricing Breakdown Component\n- Location: `components/quote/pricing-breakdown.tsx` (new)\n- Description: Display itemized pricing for quotes.\n- Estimated Tokens: 600\n- Dependencies: Phase 1 (pricing_breakdown JSONB)\n- Steps:\n  - Accept `breakdown: { items: [{name, quantity, unit_price, total}], subtotal, fees: [], taxes: [], total }`\n  - Render table with line items, subtotals, total\n  - Support optional notes per line item\n  - Responsive design for mobile\n- Acceptance Criteria:\n  - Handles empty breakdown gracefully\n  - Currency formatting consistent\n  - Accessible table markup\n\n#### Task 4.5: Admin Pricing Entry UI\n- Location: `app/admin/quotes/[id]/quote-actions.tsx` (modify)\n- Description: Allow admins to enter/edit pricing breakdown when creating quote.\n- Estimated Tokens: 800\n- Dependencies: Task 4.4\n- Steps:\n  - Add \"Create Quote\" action that transitions pending→quoted\n  - Form for pricing breakdown: add line items, set validity period\n  - Preview mode showing customer view\n  - Save triggers: update quote, generate accept token, send quote-ready email\n  - Validation: total must be positive, at least one line item\n- Acceptance Criteria:\n  - Cannot quote without pricing\n  - Saving auto-triggers customer notification\n  - Audit log captures pricing changes\n\n### Phase 5: Metrics & Expiration\n**Goal**: Track quote funnel metrics and handle automated expiration.\n\n#### Task 5.1: Quote Metrics Schema\n- Location: `supabase/migrations/018_quote_metrics.sql`\n- Description: Add computed metrics and aggregation support.\n- Estimated Tokens: 500\n- Dependencies: Phase 1\n- Steps:\n  - Create view `quote_metrics_daily` aggregating: quotes_received, quotes_sent, accepted, rejected, expired, avg_response_time, conversion_rate by day\n  - Add columns to quotes: `first_response_at timestamptz`, `response_time_hours numeric`\n  - Create function to update response_time on status change to quoted\n- Acceptance Criteria:\n  - View queryable for date ranges\n  - Response time calculated correctly\n\n#### Task 5.2: Admin Analytics Dashboard\n- Location: `app/admin/quotes/analytics/page.tsx` (new)\n- Description: Simple dashboard showing quote funnel metrics.\n- Estimated Tokens: 800\n- Dependencies: Task 5.1\n- Steps:\n  - Cards: quotes this week, conversion rate, avg response time, SLA compliance %\n  - Simple line chart: quotes over time (use existing charting lib or lightweight option)\n  - Table: top reasons for rejection\n  - Date range filter\n- Acceptance Criteria:\n  - Loads in <2s\n  - Data refreshes on navigation\n\n#### Task 5.3: Automated Expiration Job\n- Location: `app/api/cron/quote-expiration/route.ts` (new)\n- Description: Daily job to expire old quotes and send warnings.\n- Estimated Tokens: 600\n- Dependencies: Phase 4\n- Steps:\n  - Vercel cron or manual trigger endpoint with secret\n  - Find quotes: status=quoted AND expires_at < now() → update to expired\n  - Find quotes: status=quoted AND expires_at < now()+24h AND no warning sent → send expiring email\n  - Track warning_sent_at to prevent duplicates\n  - Batch process max 100 per run\n- Acceptance Criteria:\n  - Idempotent: safe to run multiple times\n  - Handles empty result sets\n  - Logs processed count\n\n#### Task 5.4: Quote Validity Extension\n- Location: `app/api/admin/quotes/[id]/extend/route.ts` (new)\n- Description: Allow admin to extend quote validity.\n- Estimated Tokens: 400\n- Dependencies: Task 5.3\n- Steps:\n  - Accept new validity_days, update expires_at\n  - Regenerate accept token with new expiry\n  - Send updated quote email to customer\n  - Audit log the extension\n- Acceptance Criteria:\n  - Cannot extend rejected/cancelled quotes\n  - Customer receives notification of extension\n\n## Testing Strategy\n- Unit tests: priority scoring, token generation/validation, SLA calculation\n- Integration tests: quote lifecycle state machine (pending→quoted→accepted), token access control\n- API tests: admin queue filters, accept/reject endpoints, expiration job\n- E2E tests: customer flow from status page to acceptance, admin flow from queue to quoting\n- Security tests: token enumeration resistance (invalid tokens return same response time), expired token rejection, SQL injection on filters\n- Load test: admin queue with 1000+ quotes, concurrent acceptance attempts\n\n## Risks\n- **Token security**: Brute-force token guessing → Mitigation: 32-char tokens = 10^38 combinations, rate limit token validation endpoint\n- **Email deliverability**: Emails marked spam → Mitigation: use Resend best practices, monitor bounce rates, include text version\n- **Race conditions**: Concurrent accept/reject → Mitigation: database transaction with row lock on quote\n- **Migration data loss**: Schema change breaks existing data → Mitigation: backup before migration, test on staging first, all new columns nullable or have defaults\n- **Self-critique: Pricing breakdown structure undefined**: The JSONB schema for pricing_breakdown is not formally validated; malformed data could break UI. Mitigation: Add Zod schema validation on write, defensive rendering on read.\n- **Self-critique: Expiration timezone handling**: expires_at stored as timestamptz but customer sees \"expires in X days\" which could be off by a day depending on their timezone. Mitigation: Store and display with explicit timezone or use date-only for validity, show \"expires on DATE\" not relative time.\n- **Self-critique: No cancel/revoke flow**: Plan lacks ability for admin to cancel a sent quote or customer to cancel acceptance. May need Task 3.5 for this.\n- **Self-critique: Slack notification overload**: High-volume periods could spam Slack channel. Mitigation: Add batching/digest option for Slack alerts.\n\n## Rollback Plan\n- Each phase has independent migration; can revert via `supabase migration repair` + manual rollback SQL\n- Feature flags: add `FEATURE_QUOTE_STATUS_PAGE=false` env var to disable new customer-facing pages without code revert\n- Token table can be truncated without affecting core quote data\n- Email templates: revert to simpler text emails via template switch\n- Queue UI: keep old flat list as fallback route `/admin/quotes/legacy`\n\n## Edge Cases\n- Customer clicks accept link after admin already marked quote rejected → Show \"quote no longer available\" message\n- Customer submits acceptance but network fails before confirmation → Backend should be idempotent; re-submit works\n- Admin creates quote but customer email bounces → Audit log shows send failure; admin can manually resend or contact customer\n- Quote expires while customer is on acceptance page → Validate expiry server-side on submit, show expiration message\n- Multiple admins try to claim same quote simultaneously → First write wins, second sees \"already assigned\" (use optimistic locking)\n- Customer loses original email, requests status link again → Admin can regenerate and resend status email from quote detail page\n\n## Open Questions\n- Should rejected quotes be allowed to be re-quoted (status: rejected → in_review → quoted)?\n- What is the default quote validity period (7 days proposed, confirm with business)?\n- Should customers be able to request quote changes/negotiation, or only accept/reject?\n- Is there a maximum pricing breakdown line items limit for UI performance?\n- Should Slack alerts go to a dedicated channel or existing operations channel?","session_id":"c57d00fd-0f49-4cb6-996b-c5eb5bcc5a59","total_cost_usd":0.16563350000000002,"usage":{"input_tokens":2,"cache_creation_input_tokens":0,"cache_read_input_tokens":14037,"output_tokens":5173,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":0}},"modelUsage":{"claude-haiku-4-5-20251001":{"inputTokens":2915,"outputTokens":100,"cacheReadInputTokens":0,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.003415,"contextWindow":200000},"claude-opus-4-5-20251101":{"inputTokens":3045,"outputTokens":5599,"cacheReadInputTokens":14037,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.16221850000000002,"contextWindow":200000}},"permission_denials":[],"uuid":"7bc151cd-49c5-497a-95e7-71e2ed259a97"}