{
  "errors": [],
  "final_plan": "# Plan\\n\\n## Overview\\nExtend quote request flow with customer-facing status/acceptance via tokenized URLs, admin prioritization queue with SLA tracking, email/Slack notifications, pricing breakdowns, and conversion metrics. Uses Supabase for schema, Resend for email, existing Slack integration.\\n\\n## Scope\\n- In:\\n  - Schema: quote lifecycle status, tokens, audit trail, pricing breakdown\\n  - Customer pages: status view, acceptance/rejection flow\\n  - Admin: prioritized queue, assignment, pricing entry, analytics\\n  - Notifications: email templates for lifecycle events, Slack for SLA breaches\\n  - Metrics: response time, conversion rate tracking\\n  - Security: 64-char tokens, expiration, audit logging, rate limiting\\n\\n- Out:\\n  - Payment processing\\n  - PortPro TMS sync\\n  - PDF generation\\n  - Automated pricing calculation\\n  - Customer portal quote history\\n\\n## Phases\\n\\n### Phase 1: Schema & Token Infrastructure\\n**Goal**: Database foundation for quote lifecycle, secure tokens, and audit trail.\\n\\n#### Task 1.1: Quote Lifecycle Schema\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Add status enum, pricing fields, expiration tracking to quotes table.\\n- Estimated Tokens: 600\\n- Dependencies: None\\n- Steps:\\n  - Create enum `quote_status`: `pending`, `in_review`, `quoted`, `accepted`, `rejected`, `expired`, `cancelled`\\n  - Add columns: `status`, `quoted_at`, `expires_at`, `accepted_at`, `rejected_at`, `rejection_reason`, `pricing_breakdown jsonb`, `total_price numeric(10,2)`, `validity_days int DEFAULT 7`, `assignee_id uuid`, `assigned_at`, `first_response_at`, `warning_sent_at`\\n  - Add indexes: `(status, created_at)`, `(expires_at)`, `(assignee_id)`\\n  - Backfill existing quotes to appropriate status\\n- Acceptance Criteria:\\n  - Migration runs on existing data without errors\\n  - Indexes exist and are used in query plans\\n\\n#### Task 1.2: Quote Tokens Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Secure token storage for public quote access.\\n- Estimated Tokens: 500\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create `quote_tokens`: `id uuid`, `quote_id uuid FK`, `token varchar(64) UNIQUE`, `type enum('status','accept')`, `expires_at timestamptz`, `used_at timestamptz`, `created_at`\\n  - RLS: allow select only via exact token match\\n  - Create function `generate_quote_token(quote_id, type, validity_hours)` using `encode(gen_random_bytes(32), 'hex')`\\n  - Index on `token`\\n- Acceptance Criteria:\\n  - Token lookup by value works; enumeration blocked by RLS\\n  - 64-char hex tokens generated\\n\\n#### Task 1.3: Audit Trail Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Log all quote state changes.\\n- Estimated Tokens: 400\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create `quote_audit_log`: `id`, `quote_id`, `action`, `old_status`, `new_status`, `actor_id`, `actor_type enum('system','admin','customer')`, `metadata jsonb`, `ip_address inet`, `created_at`\\n  - Trigger on quotes status change to auto-insert\\n  - No RLS (service role only)\\n- Acceptance Criteria:\\n  - Status changes auto-logged\\n  - IP captured when available\\n\\n#### Task 1.4: TypeScript Types Update\\n- Location: `types/database.ts`\\n- Description: Regenerate types for new schema.\\n- Estimated Tokens: 200\\n- Dependencies: Tasks 1.1-1.3\\n- Steps:\\n  - Run `supabase gen types typescript`\\n  - Add `QuoteStatus`, `QuoteToken`, `QuoteAuditLog` types\\n- Acceptance Criteria:\\n  - TypeScript compiles without errors\\n\\n#### Task 1.5: Token Rate Limiting Middleware\\n- Location: `lib/rate-limit.ts`, `middleware.ts`\\n- Description: Prevent token brute-force attacks.\\n- Estimated Tokens: 300\\n- Dependencies: Task 1.2\\n- Steps:\\n  - Add rate limit config: 10 req/min per IP for `/quote/status/*` and `/quote/accept/*`\\n  - Apply in middleware or API routes\\n  - Return 429 with generic message (no timing leak)\\n- Acceptance Criteria:\\n  - Excessive requests blocked\\n  - Response time consistent for valid/invalid tokens\\n\\n### Phase 2: Admin Queue & Prioritization\\n**Goal**: Replace flat list with prioritized, filterable queue with SLA indicators.\\n\\n#### Task 2.1: Priority Scoring Logic\\n- Location: `lib/quotes/priority.ts`\\n- Description: Calculate priority score and SLA status.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - `calculateQuotePriority(quote)` → score 0-100 based on: lead_score, hours_pending, estimated_value\\n  - `getSLAStatus(quote)` → `overdue` (>4h), `warning` (>2h), `ok`\\n  - Export SLA thresholds as config\\n- Acceptance Criteria:\\n  - Deterministic scoring\\n  - SLA thresholds configurable\\n\\n#### Task 2.2: Admin Queue API\\n- Location: `app/api/admin/quotes/route.ts`\\n- Description: Filterable, paginated queue endpoint.\\n- Estimated Tokens: 500\\n- Dependencies: Task 2.1\\n- Steps:\\n  - Query params: `status`, `sla_status`, `assignee_id`, `sort_by`, `page`, `limit`\\n  - Return quotes with priority score, SLA status, assignee info\\n  - Paginate with total count\\n- Acceptance Criteria:\\n  - Filters combinable\\n  - Response <500ms for 500 quotes\\n\\n#### Task 2.3: Admin Queue UI\\n- Location: `app/admin/quotes/page.tsx`, `components/admin/quote-queue.tsx`\\n- Description: Prioritized queue interface.\\n- Estimated Tokens: 800\\n- Dependencies: Task 2.2\\n- Steps:\\n  - Filter bar: status, SLA, assignee, search\\n  - Table with: priority badge, SLA indicator (red/yellow/green), time pending, company, assignee\\n  - Claim button, bulk assign\\n  - URL-persisted filters\\n- Acceptance Criteria:\\n  - Overdue quotes visually prominent\\n  - Keyboard accessible\\n\\n#### Task 2.4: Quote Assignment API\\n- Location: `app/api/admin/quotes/[id]/assign/route.ts`\\n- Description: Assign/claim quotes.\\n- Estimated Tokens: 300\\n- Dependencies: Task 2.3\\n- Steps:\\n  - POST with `assignee_id`\\n  - Update quote, log to audit\\n  - Optimistic locking via `updated_at` check\\n- Acceptance Criteria:\\n  - Concurrent claims: first wins\\n  - Audit logged\\n\\n### Phase 3: Customer Status & Acceptance\\n**Goal**: Secure customer-facing quote viewing and acceptance.\\n\\n#### Task 3.1: Token Service\\n- Location: `lib/quotes/tokens.ts`\\n- Description: Generate, validate, revoke tokens.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - `createStatusToken(quoteId)` → 64-char token, 30-day expiry\\n  - `createAcceptToken(quoteId)` → 64-char token, expires with quote\\n  - `validateToken(token, type)` → quote or null\\n  - Use `crypto.randomBytes(32).toString('hex')`\\n- Acceptance Criteria:\\n  - Tokens cryptographically random\\n  - Expired/used tokens return null\\n\\n#### Task 3.2: Update Quote Submission Flow\\n- Location: `app/api/quote/route.ts`\\n- Description: Generate status token on new quote, include in confirmation email.\\n- Estimated Tokens: 300\\n- Dependencies: Task 3.1\\n- Steps:\\n  - After quote insert, call `createStatusToken(quoteId)`\\n  - Pass token URL to confirmation email\\n  - Store token reference in quote metadata\\n- Acceptance Criteria:\\n  - Every new quote gets status token\\n  - Email contains valid tracking link\\n\\n#### Task 3.3: Public Status Page\\n- Location: `app/quote/status/[token]/page.tsx`\\n- Description: Customer quote status view.\\n- Estimated Tokens: 600\\n- Dependencies: Task 3.1\\n- Steps:\\n  - Server component: validate token, fetch quote\\n  - Display: status badge, timeline, pricing (if quoted), validity countdown\\n  - If quoted: show accept/reject buttons\\n  - Invalid token: generic \\\"quote not found\\\" (no enumeration hints)\\n- Acceptance Criteria:\\n  - No internal data exposed (lead scores, admin notes)\\n  - Mobile responsive\\n\\n#### Task 3.4: Acceptance Page\\n- Location: `app/quote/accept/[token]/page.tsx`\\n- Description: Accept/reject form.\\n- Estimated Tokens: 600\\n- Dependencies: Task 3.3\\n- Steps:\\n  - Validate accept-type token\\n  - Show pricing breakdown, terms checkbox, signature field (typed name)\\n  - Reject option with reason dropdown\\n  - POST to `/api/quote/accept`\\n- Acceptance Criteria:\\n  - Cannot submit without checkbox + signature\\n  - Expired quote shows error\\n\\n#### Task 3.5: Accept/Reject API\\n- Location: `app/api/quote/accept/route.ts`\\n- Description: Process acceptance/rejection.\\n- Estimated Tokens: 400\\n- Dependencies: Task 3.4\\n- Steps:\\n  - Validate token, check status=quoted, not expired\\n  - Transaction: update status, mark token used, audit log with IP\\n  - Return confirmation number\\n  - Idempotent: re-accept returns existing confirmation\\n- Acceptance Criteria:\\n  - Race-safe via transaction\\n  - Audit captures IP\\n\\n### Phase 4: Notifications & Pricing\\n**Goal**: Email/Slack notifications and pricing entry.\\n\\n#### Task 4.1: Email Templates\\n- Location: `lib/emails/templates/`\\n- Description: React Email templates for quote lifecycle.\\n- Estimated Tokens: 600\\n- Dependencies: Phase 3\\n- Steps:\\n  - `quote-received.tsx`: confirmation + status link\\n  - `quote-ready.tsx`: pricing summary + accept link\\n  - `quote-accepted.tsx`: confirmation + next steps\\n  - `quote-expiring.tsx`: 24h warning\\n  - Consistent branding, mobile responsive\\n- Acceptance Criteria:\\n  - All templates render correctly\\n  - Links use NEXT_PUBLIC_SITE_URL\\n\\n#### Task 4.2: Email Service\\n- Location: `lib/notifications/email.ts`\\n- Description: Send emails via Resend with logging.\\n- Estimated Tokens: 400\\n- Dependencies: Task 4.1\\n- Steps:\\n  - `sendQuoteEmail(type, quote, tokens)`\\n  - Log sends to audit trail\\n  - Retry on transient failures\\n  - Dedupe: one email type per quote per hour\\n- Acceptance Criteria:\\n  - Failures logged, don't crash\\n  - Duplicates prevented\\n\\n#### Task 4.3: Slack Notifications\\n- Location: `lib/notifications/slack.ts`\\n- Description: Alert on high-priority events.\\n- Estimated Tokens: 300\\n- Dependencies: Phase 2\\n- Steps:\\n  - Events: new high-priority quote, SLA breach, quote accepted\\n  - Include admin deep link\\n  - Skip if webhook not configured\\n- Acceptance Criteria:\\n  - No spam on high volume (debounce)\\n  - Graceful skip if no webhook\\n\\n#### Task 4.4: Pricing Breakdown Component\\n- Location: `components/quote/pricing-breakdown.tsx`\\n- Description: Display itemized pricing.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - Accept `{ items: [{name, qty, unit_price, total}], subtotal, fees, taxes, total }`\\n  - Render accessible table\\n  - Handle empty gracefully\\n- Acceptance Criteria:\\n  - Currency formatting consistent\\n  - Mobile responsive\\n\\n#### Task 4.5: Admin Pricing Entry\\n- Location: `app/admin/quotes/[id]/quote-actions.tsx`\\n- Description: Enter pricing and send quote.\\n- Estimated Tokens: 500\\n- Dependencies: Task 4.4\\n- Steps:\\n  - \\\"Create Quote\\\" action: pricing form, validity period\\n  - Preview mode\\n  - Save: update quote to `quoted`, generate accept token, send email\\n  - Validate: positive total, at least one item\\n- Acceptance Criteria:\\n  - Cannot quote without pricing\\n  - Email sent on save\\n\\n### Phase 5: Metrics & Expiration\\n**Goal**: Track funnel metrics, automate expiration.\\n\\n#### Task 5.1: Metrics View\\n- Location: `supabase/migrations/017_quote_metrics.sql`\\n- Description: Aggregated metrics view.\\n- Estimated Tokens: 300\\n- Dependencies: Phase 1\\n- Steps:\\n  - Create view `quote_metrics_daily`: quotes_received, quoted, accepted, rejected, expired, avg_response_time, conversion_rate by date\\n  - Update `first_response_at` via trigger when status→quoted\\n- Acceptance Criteria:\\n  - View queryable by date range\\n  - Response time accurate\\n\\n#### Task 5.2: Analytics Dashboard\\n- Location: `app/admin/quotes/analytics/page.tsx`\\n- Description: Simple metrics dashboard.\\n- Estimated Tokens: 500\\n- Dependencies: Task 5.1\\n- Steps:\\n  - Cards: weekly quotes, conversion rate, avg response time, SLA compliance\\n  - Date range filter\\n  - Optional: rejection reasons table\\n- Acceptance Criteria:\\n  - Loads <2s\\n  - Data accurate\\n\\n#### Task 5.3: Expiration Job\\n- Location: `app/api/cron/quote-expiration/route.ts`\\n- Description: Expire quotes and send warnings.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 4\\n- Steps:\\n  - Trigger via Vercel cron or secret-protected GET\\n  - Expire: status=quoted AND expires_at<now() → status=expired\\n  - Warn: expires_at<now()+24h AND warning_sent_at IS NULL → send email, set warning_sent_at\\n  - Batch 100 per run\\n- Acceptance Criteria:\\n  - Idempotent\\n  - Logs count processed\\n\\n#### Task 5.4: Validity Extension\\n- Location: `app/api/admin/quotes/[id]/extend/route.ts`\\n- Description: Extend quote validity.\\n- Estimated Tokens: 250\\n- Dependencies: Task 5.3\\n- Steps:\\n  - Accept `validity_days`, update `expires_at`\\n  - Regenerate accept token\\n  - Send notification\\n  - Audit log\\n- Acceptance Criteria:\\n  - Cannot extend rejected quotes\\n  - Customer notified\\n\\n## Testing Strategy\\n- **Unit**: priority scoring, token generation/validation, SLA calculation\\n- **Integration**: quote state machine transitions, token access control\\n- **API**: queue filters, accept/reject endpoints, expiration job idempotency\\n- **E2E**: customer flow (status→accept), admin flow (queue→quote→send)\\n- **Security**: token enumeration (consistent timing), rate limiting, expired token rejection\\n- **Load**: queue with 1000+ quotes, concurrent acceptance\\n\\n## Risks\\n- **Token brute-force**: 64-char tokens + rate limiting mitigates\\n- **Race conditions**: Database transactions with row locks\\n- **Email deliverability**: Monitor bounces, use Resend best practices\\n- **Pricing JSONB corruption**: Zod validation on write, defensive rendering\\n- **Timezone confusion on expiry**: Display absolute date, not relative time\\n- **Slack spam**: Debounce/batch alerts in high volume\\n\\n## Rollback Plan\\n- Migrations revertible via Supabase CLI + rollback SQL\\n- Feature flag: `FEATURE_QUOTE_LIFECYCLE=false` disables new pages\\n- Keep `/admin/quotes/legacy` as flat list fallback\\n- Token table can be truncated without quote data loss\\n\\n## Edge Cases\\n- Accept after admin rejection → \\\"Quote no longer available\\\"\\n- Network fail during accept → Idempotent re-submit works\\n- Customer on accept page when quote expires → Server-side validation on submit\\n- Concurrent admin claims → First write wins, second sees error\\n- Customer loses email → Admin can resend from quote detail\\n- Email bounce → Audit log records failure, admin can retry\\n\\n## Open Questions\\n- Can rejected quotes be re-quoted? (Suggest: yes, via new revision)\\n- Default validity period? (Proposed: 7 days)\\n- Customer negotiation flow needed? (Suggest: Phase 2, out of scope)\\n- Max pricing line items? (Suggest: 50 for UI)\\n- Dedicated Slack channel? (Suggest: yes, `#quote-alerts`)\",\"session_id\":\"17bde826-a8df-488e-969c-841a2220529c\",\"total_cost_usd\":0.21072549999999998,\"usage\":{\"input_tokens\":2,\"cache_creation_input_tokens\":9180,\"cache_read_input_tokens\":10841,\"output_tokens\":4671,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":9180}},\"modelUsage\":{\"claude-haiku-4-5-20251001\":{\"inputTokens\":2915,\"outputTokens\":188,\"cacheReadInputTokens\":0,\"cacheCreationInputTokens\":0,\"webSearchRequests\":0,\"costUSD\":0.003855,\"contextWindow\":200000},\"claude-opus-4-5-20251101\":{\"inputTokens\":3045,\"outputTokens\":5154,\"cacheReadInputTokens\":10841,\"cacheCreationInputTokens\":9180,\"webSearchRequests\":0,\"costUSD\":0.20687049999999998,\"contextWindow\":200000}},\"permission_denials\":[],\"uuid\":\"6224e228-85a3-457a-99a5-62031973d66a\"}",
  "judge": {
    "errors": [],
    "status": "complete",
    "summary": "{\"type\":\"result\",\"subtype\":\"success\",\"is_error\":false,\"duration_ms\":87220,\"duration_api_ms\":98636,\"num_turns\":1,\"result\":\"# Judge Report\\n\\n## Scores\\n- Plan 1: 8.5/10\\n\\n## Comparative Analysis\\nOnly one plan was provided for evaluation. Plan 1 demonstrates comprehensive coverage of the requirements including schema changes, customer-facing status/acceptance flows, admin queue prioritization, notifications, pricing breakdowns, and metrics tracking. The plan is well-structured with clear phases, dependencies, and acceptance criteria.\\n\\n**Strengths:**\\n- Thorough coverage of all Tier 1-3 improvements\\n- Strong security considerations (tokenized URLs, audit trails, RLS policies)\\n- Good risk identification with self-critique section\\n- Clear dependency chains between tasks\\n- Practical rollback strategies\\n\\n**Weaknesses:**\\n- Overly verbose in places (descriptions repeat information)\\n- Some token estimates seem arbitrary without clear justification\\n- Missing explicit rate limiting on token validation endpoints (mentioned in risks but not in tasks)\\n- No explicit task for updating existing quote form to generate status tokens on submission\\n- Expiration job assumes Vercel cron availability without fallback\\n\\n## Missing Steps\\n- Token validation rate limiting implementation (API middleware)\\n- Update initial quote submission to generate/send status token\\n- Database index on `expires_at` for expiration job performance\\n- Webhook/realtime subscription setup for admin queue updates\\n- Customer email change/correction flow\\n- Quote revision/amendment workflow (re-quoting an existing quote)\\n- Error boundary components for public-facing pages\\n\\n## Contradictions\\n- Task 4.5 says saving \\\"auto-triggers customer notification\\\" but Task 4.2 rate limits \\\"max 3 emails per quote per hour\\\" - potential conflict if admin saves multiple times quickly\\n- Phase 1 mentions \\\"32-char random token\\\" but Task 3.1 also says \\\"32-char\\\" - inconsistent with security section mentioning 10^38 combinations (which requires ~64 chars for that entropy)\\n\\n## Improvements\\n- Consolidate token length to 64 chars for stated security properties\\n- Add explicit task for rate limiting middleware on token endpoints\\n- Include status token generation in initial quote submission flow\\n- Add database indexes for expiration queries\\n- Simplify email rate limiting to per-email-type basis rather than global\\n\\n## Final Plan\\n\\n# Plan\\n\\n## Overview\\nExtend quote request flow with customer-facing status/acceptance via tokenized URLs, admin prioritization queue with SLA tracking, email/Slack notifications, pricing breakdowns, and conversion metrics. Uses Supabase for schema, Resend for email, existing Slack integration.\\n\\n## Scope\\n- In:\\n  - Schema: quote lifecycle status, tokens, audit trail, pricing breakdown\\n  - Customer pages: status view, acceptance/rejection flow\\n  - Admin: prioritized queue, assignment, pricing entry, analytics\\n  - Notifications: email templates for lifecycle events, Slack for SLA breaches\\n  - Metrics: response time, conversion rate tracking\\n  - Security: 64-char tokens, expiration, audit logging, rate limiting\\n\\n- Out:\\n  - Payment processing\\n  - PortPro TMS sync\\n  - PDF generation\\n  - Automated pricing calculation\\n  - Customer portal quote history\\n\\n## Phases\\n\\n### Phase 1: Schema & Token Infrastructure\\n**Goal**: Database foundation for quote lifecycle, secure tokens, and audit trail.\\n\\n#### Task 1.1: Quote Lifecycle Schema\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Add status enum, pricing fields, expiration tracking to quotes table.\\n- Estimated Tokens: 600\\n- Dependencies: None\\n- Steps:\\n  - Create enum `quote_status`: `pending`, `in_review`, `quoted`, `accepted`, `rejected`, `expired`, `cancelled`\\n  - Add columns: `status`, `quoted_at`, `expires_at`, `accepted_at`, `rejected_at`, `rejection_reason`, `pricing_breakdown jsonb`, `total_price numeric(10,2)`, `validity_days int DEFAULT 7`, `assignee_id uuid`, `assigned_at`, `first_response_at`, `warning_sent_at`\\n  - Add indexes: `(status, created_at)`, `(expires_at)`, `(assignee_id)`\\n  - Backfill existing quotes to appropriate status\\n- Acceptance Criteria:\\n  - Migration runs on existing data without errors\\n  - Indexes exist and are used in query plans\\n\\n#### Task 1.2: Quote Tokens Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Secure token storage for public quote access.\\n- Estimated Tokens: 500\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create `quote_tokens`: `id uuid`, `quote_id uuid FK`, `token varchar(64) UNIQUE`, `type enum('status','accept')`, `expires_at timestamptz`, `used_at timestamptz`, `created_at`\\n  - RLS: allow select only via exact token match\\n  - Create function `generate_quote_token(quote_id, type, validity_hours)` using `encode(gen_random_bytes(32), 'hex')`\\n  - Index on `token`\\n- Acceptance Criteria:\\n  - Token lookup by value works; enumeration blocked by RLS\\n  - 64-char hex tokens generated\\n\\n#### Task 1.3: Audit Trail Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Log all quote state changes.\\n- Estimated Tokens: 400\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create `quote_audit_log`: `id`, `quote_id`, `action`, `old_status`, `new_status`, `actor_id`, `actor_type enum('system','admin','customer')`, `metadata jsonb`, `ip_address inet`, `created_at`\\n  - Trigger on quotes status change to auto-insert\\n  - No RLS (service role only)\\n- Acceptance Criteria:\\n  - Status changes auto-logged\\n  - IP captured when available\\n\\n#### Task 1.4: TypeScript Types Update\\n- Location: `types/database.ts`\\n- Description: Regenerate types for new schema.\\n- Estimated Tokens: 200\\n- Dependencies: Tasks 1.1-1.3\\n- Steps:\\n  - Run `supabase gen types typescript`\\n  - Add `QuoteStatus`, `QuoteToken`, `QuoteAuditLog` types\\n- Acceptance Criteria:\\n  - TypeScript compiles without errors\\n\\n#### Task 1.5: Token Rate Limiting Middleware\\n- Location: `lib/rate-limit.ts`, `middleware.ts`\\n- Description: Prevent token brute-force attacks.\\n- Estimated Tokens: 300\\n- Dependencies: Task 1.2\\n- Steps:\\n  - Add rate limit config: 10 req/min per IP for `/quote/status/*` and `/quote/accept/*`\\n  - Apply in middleware or API routes\\n  - Return 429 with generic message (no timing leak)\\n- Acceptance Criteria:\\n  - Excessive requests blocked\\n  - Response time consistent for valid/invalid tokens\\n\\n### Phase 2: Admin Queue & Prioritization\\n**Goal**: Replace flat list with prioritized, filterable queue with SLA indicators.\\n\\n#### Task 2.1: Priority Scoring Logic\\n- Location: `lib/quotes/priority.ts`\\n- Description: Calculate priority score and SLA status.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - `calculateQuotePriority(quote)` → score 0-100 based on: lead_score, hours_pending, estimated_value\\n  - `getSLAStatus(quote)` → `overdue` (>4h), `warning` (>2h), `ok`\\n  - Export SLA thresholds as config\\n- Acceptance Criteria:\\n  - Deterministic scoring\\n  - SLA thresholds configurable\\n\\n#### Task 2.2: Admin Queue API\\n- Location: `app/api/admin/quotes/route.ts`\\n- Description: Filterable, paginated queue endpoint.\\n- Estimated Tokens: 500\\n- Dependencies: Task 2.1\\n- Steps:\\n  - Query params: `status`, `sla_status`, `assignee_id`, `sort_by`, `page`, `limit`\\n  - Return quotes with priority score, SLA status, assignee info\\n  - Paginate with total count\\n- Acceptance Criteria:\\n  - Filters combinable\\n  - Response <500ms for 500 quotes\\n\\n#### Task 2.3: Admin Queue UI\\n- Location: `app/admin/quotes/page.tsx`, `components/admin/quote-queue.tsx`\\n- Description: Prioritized queue interface.\\n- Estimated Tokens: 800\\n- Dependencies: Task 2.2\\n- Steps:\\n  - Filter bar: status, SLA, assignee, search\\n  - Table with: priority badge, SLA indicator (red/yellow/green), time pending, company, assignee\\n  - Claim button, bulk assign\\n  - URL-persisted filters\\n- Acceptance Criteria:\\n  - Overdue quotes visually prominent\\n  - Keyboard accessible\\n\\n#### Task 2.4: Quote Assignment API\\n- Location: `app/api/admin/quotes/[id]/assign/route.ts`\\n- Description: Assign/claim quotes.\\n- Estimated Tokens: 300\\n- Dependencies: Task 2.3\\n- Steps:\\n  - POST with `assignee_id`\\n  - Update quote, log to audit\\n  - Optimistic locking via `updated_at` check\\n- Acceptance Criteria:\\n  - Concurrent claims: first wins\\n  - Audit logged\\n\\n### Phase 3: Customer Status & Acceptance\\n**Goal**: Secure customer-facing quote viewing and acceptance.\\n\\n#### Task 3.1: Token Service\\n- Location: `lib/quotes/tokens.ts`\\n- Description: Generate, validate, revoke tokens.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - `createStatusToken(quoteId)` → 64-char token, 30-day expiry\\n  - `createAcceptToken(quoteId)` → 64-char token, expires with quote\\n  - `validateToken(token, type)` → quote or null\\n  - Use `crypto.randomBytes(32).toString('hex')`\\n- Acceptance Criteria:\\n  - Tokens cryptographically random\\n  - Expired/used tokens return null\\n\\n#### Task 3.2: Update Quote Submission Flow\\n- Location: `app/api/quote/route.ts`\\n- Description: Generate status token on new quote, include in confirmation email.\\n- Estimated Tokens: 300\\n- Dependencies: Task 3.1\\n- Steps:\\n  - After quote insert, call `createStatusToken(quoteId)`\\n  - Pass token URL to confirmation email\\n  - Store token reference in quote metadata\\n- Acceptance Criteria:\\n  - Every new quote gets status token\\n  - Email contains valid tracking link\\n\\n#### Task 3.3: Public Status Page\\n- Location: `app/quote/status/[token]/page.tsx`\\n- Description: Customer quote status view.\\n- Estimated Tokens: 600\\n- Dependencies: Task 3.1\\n- Steps:\\n  - Server component: validate token, fetch quote\\n  - Display: status badge, timeline, pricing (if quoted), validity countdown\\n  - If quoted: show accept/reject buttons\\n  - Invalid token: generic \\\"quote not found\\\" (no enumeration hints)\\n- Acceptance Criteria:\\n  - No internal data exposed (lead scores, admin notes)\\n  - Mobile responsive\\n\\n#### Task 3.4: Acceptance Page\\n- Location: `app/quote/accept/[token]/page.tsx`\\n- Description: Accept/reject form.\\n- Estimated Tokens: 600\\n- Dependencies: Task 3.3\\n- Steps:\\n  - Validate accept-type token\\n  - Show pricing breakdown, terms checkbox, signature field (typed name)\\n  - Reject option with reason dropdown\\n  - POST to `/api/quote/accept`\\n- Acceptance Criteria:\\n  - Cannot submit without checkbox + signature\\n  - Expired quote shows error\\n\\n#### Task 3.5: Accept/Reject API\\n- Location: `app/api/quote/accept/route.ts`\\n- Description: Process acceptance/rejection.\\n- Estimated Tokens: 400\\n- Dependencies: Task 3.4\\n- Steps:\\n  - Validate token, check status=quoted, not expired\\n  - Transaction: update status, mark token used, audit log with IP\\n  - Return confirmation number\\n  - Idempotent: re-accept returns existing confirmation\\n- Acceptance Criteria:\\n  - Race-safe via transaction\\n  - Audit captures IP\\n\\n### Phase 4: Notifications & Pricing\\n**Goal**: Email/Slack notifications and pricing entry.\\n\\n#### Task 4.1: Email Templates\\n- Location: `lib/emails/templates/`\\n- Description: React Email templates for quote lifecycle.\\n- Estimated Tokens: 600\\n- Dependencies: Phase 3\\n- Steps:\\n  - `quote-received.tsx`: confirmation + status link\\n  - `quote-ready.tsx`: pricing summary + accept link\\n  - `quote-accepted.tsx`: confirmation + next steps\\n  - `quote-expiring.tsx`: 24h warning\\n  - Consistent branding, mobile responsive\\n- Acceptance Criteria:\\n  - All templates render correctly\\n  - Links use NEXT_PUBLIC_SITE_URL\\n\\n#### Task 4.2: Email Service\\n- Location: `lib/notifications/email.ts`\\n- Description: Send emails via Resend with logging.\\n- Estimated Tokens: 400\\n- Dependencies: Task 4.1\\n- Steps:\\n  - `sendQuoteEmail(type, quote, tokens)`\\n  - Log sends to audit trail\\n  - Retry on transient failures\\n  - Dedupe: one email type per quote per hour\\n- Acceptance Criteria:\\n  - Failures logged, don't crash\\n  - Duplicates prevented\\n\\n#### Task 4.3: Slack Notifications\\n- Location: `lib/notifications/slack.ts`\\n- Description: Alert on high-priority events.\\n- Estimated Tokens: 300\\n- Dependencies: Phase 2\\n- Steps:\\n  - Events: new high-priority quote, SLA breach, quote accepted\\n  - Include admin deep link\\n  - Skip if webhook not configured\\n- Acceptance Criteria:\\n  - No spam on high volume (debounce)\\n  - Graceful skip if no webhook\\n\\n#### Task 4.4: Pricing Breakdown Component\\n- Location: `components/quote/pricing-breakdown.tsx`\\n- Description: Display itemized pricing.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 1\\n- Steps:\\n  - Accept `{ items: [{name, qty, unit_price, total}], subtotal, fees, taxes, total }`\\n  - Render accessible table\\n  - Handle empty gracefully\\n- Acceptance Criteria:\\n  - Currency formatting consistent\\n  - Mobile responsive\\n\\n#### Task 4.5: Admin Pricing Entry\\n- Location: `app/admin/quotes/[id]/quote-actions.tsx`\\n- Description: Enter pricing and send quote.\\n- Estimated Tokens: 500\\n- Dependencies: Task 4.4\\n- Steps:\\n  - \\\"Create Quote\\\" action: pricing form, validity period\\n  - Preview mode\\n  - Save: update quote to `quoted`, generate accept token, send email\\n  - Validate: positive total, at least one item\\n- Acceptance Criteria:\\n  - Cannot quote without pricing\\n  - Email sent on save\\n\\n### Phase 5: Metrics & Expiration\\n**Goal**: Track funnel metrics, automate expiration.\\n\\n#### Task 5.1: Metrics View\\n- Location: `supabase/migrations/017_quote_metrics.sql`\\n- Description: Aggregated metrics view.\\n- Estimated Tokens: 300\\n- Dependencies: Phase 1\\n- Steps:\\n  - Create view `quote_metrics_daily`: quotes_received, quoted, accepted, rejected, expired, avg_response_time, conversion_rate by date\\n  - Update `first_response_at` via trigger when status→quoted\\n- Acceptance Criteria:\\n  - View queryable by date range\\n  - Response time accurate\\n\\n#### Task 5.2: Analytics Dashboard\\n- Location: `app/admin/quotes/analytics/page.tsx`\\n- Description: Simple metrics dashboard.\\n- Estimated Tokens: 500\\n- Dependencies: Task 5.1\\n- Steps:\\n  - Cards: weekly quotes, conversion rate, avg response time, SLA compliance\\n  - Date range filter\\n  - Optional: rejection reasons table\\n- Acceptance Criteria:\\n  - Loads <2s\\n  - Data accurate\\n\\n#### Task 5.3: Expiration Job\\n- Location: `app/api/cron/quote-expiration/route.ts`\\n- Description: Expire quotes and send warnings.\\n- Estimated Tokens: 400\\n- Dependencies: Phase 4\\n- Steps:\\n  - Trigger via Vercel cron or secret-protected GET\\n  - Expire: status=quoted AND expires_at<now() → status=expired\\n  - Warn: expires_at<now()+24h AND warning_sent_at IS NULL → send email, set warning_sent_at\\n  - Batch 100 per run\\n- Acceptance Criteria:\\n  - Idempotent\\n  - Logs count processed\\n\\n#### Task 5.4: Validity Extension\\n- Location: `app/api/admin/quotes/[id]/extend/route.ts`\\n- Description: Extend quote validity.\\n- Estimated Tokens: 250\\n- Dependencies: Task 5.3\\n- Steps:\\n  - Accept `validity_days`, update `expires_at`\\n  - Regenerate accept token\\n  - Send notification\\n  - Audit log\\n- Acceptance Criteria:\\n  - Cannot extend rejected quotes\\n  - Customer notified\\n\\n## Testing Strategy\\n- **Unit**: priority scoring, token generation/validation, SLA calculation\\n- **Integration**: quote state machine transitions, token access control\\n- **API**: queue filters, accept/reject endpoints, expiration job idempotency\\n- **E2E**: customer flow (status→accept), admin flow (queue→quote→send)\\n- **Security**: token enumeration (consistent timing), rate limiting, expired token rejection\\n- **Load**: queue with 1000+ quotes, concurrent acceptance\\n\\n## Risks\\n- **Token brute-force**: 64-char tokens + rate limiting mitigates\\n- **Race conditions**: Database transactions with row locks\\n- **Email deliverability**: Monitor bounces, use Resend best practices\\n- **Pricing JSONB corruption**: Zod validation on write, defensive rendering\\n- **Timezone confusion on expiry**: Display absolute date, not relative time\\n- **Slack spam**: Debounce/batch alerts in high volume\\n\\n## Rollback Plan\\n- Migrations revertible via Supabase CLI + rollback SQL\\n- Feature flag: `FEATURE_QUOTE_LIFECYCLE=false` disables new pages\\n- Keep `/admin/quotes/legacy` as flat list fallback\\n- Token table can be truncated without quote data loss\\n\\n## Edge Cases\\n- Accept after admin rejection → \\\"Quote no longer available\\\"\\n- Network fail during accept → Idempotent re-submit works\\n- Customer on accept page when quote expires → Server-side validation on submit\\n- Concurrent admin claims → First write wins, second sees error\\n- Customer loses email → Admin can resend from quote detail\\n- Email bounce → Audit log records failure, admin can retry\\n\\n## Open Questions\\n- Can rejected quotes be re-quoted? (Suggest: yes, via new revision)\\n- Default validity period? (Proposed: 7 days)\\n- Customer negotiation flow needed? (Suggest: Phase 2, out of scope)\\n- Max pricing line items? (Suggest: 50 for UI)\\n- Dedicated Slack channel? (Suggest: yes, `#quote-alerts`)\",\"session_id\":\"17bde826-a8df-488e-969c-841a2220529c\",\"total_cost_usd\":0.21072549999999998,\"usage\":{\"input_tokens\":2,\"cache_creation_input_tokens\":9180,\"cache_read_input_tokens\":10841,\"output_tokens\":4671,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":9180}},\"modelUsage\":{\"claude-haiku-4-5-20251001\":{\"inputTokens\":2915,\"outputTokens\":188,\"cacheReadInputTokens\":0,\"cacheCreationInputTokens\":0,\"webSearchRequests\":0,\"costUSD\":0.003855,\"contextWindow\":200000},\"claude-opus-4-5-20251101\":{\"inputTokens\":3045,\"outputTokens\":5154,\"cacheReadInputTokens\":10841,\"cacheCreationInputTokens\":9180,\"webSearchRequests\":0,\"costUSD\":0.20687049999999998,\"contextWindow\":200000}},\"permission_denials\":[],\"uuid\":\"6224e228-85a3-457a-99a5-62031973d66a\"}"
  },
  "keep_open": true,
  "phase": "complete",
  "planners": [
    {
      "errors": [],
      "id": "claude-1",
      "status": "complete",
      "summary": "{\"type\":\"result\",\"subtype\":\"success\",\"is_error\":false,\"duration_ms\":104647,\"duration_api_ms\":115761,\"num_turns\":1,\"result\":\"# Plan\\n\\n## Overview\\nExtend the existing quote request flow to include customer-facing quote status/acceptance, admin prioritization queue, email/Slack notifications at key lifecycle stages, pricing breakdowns, and tracking metrics. Uses tokenized URLs for secure public access with audit trails.\\n\\n## Scope\\n- In:\\n  - Database schema changes for quote lifecycle, tokens, pricing breakdowns, metrics\\n  - Customer-facing status page with secure token access\\n  - Quote acceptance/rejection flow with digital signature\\n  - Admin queue with prioritization, filtering, SLA indicators\\n  - Email notifications (quote received, quote ready, accepted/rejected, expiration warnings)\\n  - Slack notifications for high-priority quotes and SLA breaches\\n  - Pricing breakdown storage and display\\n  - Basic analytics/metrics tracking\\n  - Audit trail for all quote state changes\\n\\n- Out:\\n  - Payment processing integration\\n  - PortPro TMS quote sync (future work)\\n  - Customer portal quote history (existing dashboard scope)\\n  - Automated pricing calculation engine\\n  - PDF quote generation (can be Phase 4)\\n\\n## Phases\\n\\n### Phase 1: Schema & Token Infrastructure\\n**Goal**: Establish database foundation for quote lifecycle, secure tokens, and audit trail.\\n\\n#### Task 1.1: Quote Lifecycle Schema Migration\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Add quote status enum, pricing breakdown JSONB, expiration fields, and acceptance fields to quotes table.\\n- Estimated Tokens: 800\\n- Dependencies: None\\n- Steps:\\n  - Create enum `quote_status` with values: `pending`, `in_review`, `quoted`, `accepted`, `rejected`, `expired`, `cancelled`\\n  - Add columns: `status quote_status DEFAULT 'pending'`, `quoted_at timestamptz`, `expires_at timestamptz`, `accepted_at timestamptz`, `rejected_at timestamptz`, `rejection_reason text`, `pricing_breakdown jsonb`, `total_price numeric(10,2)`, `validity_days int DEFAULT 7`\\n  - Add index on `status` and `created_at` for queue queries\\n  - Backfill existing quotes to `pending` or `quoted` based on presence of pricing data\\n- Acceptance Criteria:\\n  - Migration runs without error on existing data\\n  - Existing quotes retain all current data\\n  - New status column queryable\\n\\n#### Task 1.2: Quote Token Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql` (same migration)\\n- Description: Create secure token table for public quote access links.\\n- Estimated Tokens: 600\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create table `quote_tokens` with: `id uuid PK`, `quote_id uuid FK NOT NULL`, `token varchar(64) UNIQUE NOT NULL`, `type enum('status', 'accept')`, `expires_at timestamptz NOT NULL`, `used_at timestamptz`, `created_at timestamptz DEFAULT now()`\\n  - Add RLS policy: tokens readable only via exact token match (no user auth required for public access)\\n  - Create function `generate_quote_token(quote_id, type, validity_hours)` returning token string\\n  - Index on `token` for fast lookup\\n- Acceptance Criteria:\\n  - Tokens can be generated and retrieved by exact match\\n  - RLS prevents enumeration attacks\\n  - Expired tokens return no results\\n\\n#### Task 1.3: Quote Audit Trail Table\\n- Location: `supabase/migrations/016_quote_lifecycle.sql`\\n- Description: Track all quote state changes for compliance and debugging.\\n- Estimated Tokens: 500\\n- Dependencies: Task 1.1\\n- Steps:\\n  - Create table `quote_audit_log` with: `id uuid PK`, `quote_id uuid FK NOT NULL`, `action varchar(50) NOT NULL`, `old_status quote_status`, `new_status quote_status`, `actor_id uuid` (nullable for system/customer actions), `actor_type enum('system', 'admin', 'customer')`, `metadata jsonb`, `ip_address inet`, `created_at timestamptz DEFAULT now()`\\n  - Create trigger function to auto-log status changes on quotes table\\n  - No RLS (admin-only access via service role)\\n- Acceptance Criteria:\\n  - Every status change creates audit record automatically\\n  - Manual audit entries can be created via insert\\n  - IP address captured when available\\n\\n#### Task 1.4: Update TypeScript Types\\n- Location: `types/database.ts`\\n- Description: Regenerate or manually update types to include new schema.\\n- Estimated Tokens: 400\\n- Dependencies: Tasks 1.1-1.3\\n- Steps:\\n  - Run `supabase gen types typescript` or manually add types\\n  - Add `QuoteStatus` type union\\n  - Add `QuoteToken`, `QuoteAuditLog` interfaces\\n  - Update `Quote` interface with new fields\\n- Acceptance Criteria:\\n  - TypeScript compilation passes\\n  - New fields accessible with proper types\\n\\n### Phase 2: Admin Queue & Prioritization\\n**Goal**: Replace flat admin list with prioritized, filterable queue with SLA indicators.\\n\\n#### Task 2.1: Quote Priority Scoring\\n- Location: `lib/quotes/priority.ts` (new)\\n- Description: Implement priority calculation based on lead score, age, value, and SLA.\\n- Estimated Tokens: 600\\n- Dependencies: Phase 1\\n- Steps:\\n  - Create function `calculateQuotePriority(quote)` returning score 0-100\\n  - Factors: lead_score (from 015 migration), hours since created, estimated value, customer tier\\n  - Define SLA thresholds: respond within 4h (high), 8h (medium), 24h (low)\\n  - Export `getSLAStatus(quote)` returning `overdue | warning | ok`\\n- Acceptance Criteria:\\n  - Priority scores deterministic for same inputs\\n  - SLA status correctly reflects time thresholds\\n\\n#### Task 2.2: Admin Queue API Endpoint\\n- Location: `app/api/admin/quotes/route.ts` (modify existing or create)\\n- Description: Add filtering, sorting, pagination for admin queue.\\n- Estimated Tokens: 800\\n- Dependencies: Task 2.1\\n- Steps:\\n  - Accept query params: `status`, `priority_min`, `sla_status`, `sort_by`, `sort_order`, `page`, `limit`\\n  - Join with organization for customer context\\n  - Calculate priority score in-memory or via computed column\\n  - Return paginated results with total count\\n  - Add `assignee_id` filter for \\\"my quotes\\\" view\\n- Acceptance Criteria:\\n  - Filters work independently and combined\\n  - Pagination returns correct totals\\n  - Response time <500ms for typical queries\\n\\n#### Task 2.3: Admin Queue UI\\n- Location: `app/admin/quotes/page.tsx`, `components/admin/quote-queue.tsx` (new)\\n- Description: Build prioritized queue interface with filters and SLA badges.\\n- Estimated Tokens: 1200\\n- Dependencies: Task 2.2\\n- Steps:\\n  - Create `QuoteQueue` component with table/card view toggle\\n  - Add filter bar: status dropdown, SLA status, search by company/email\\n  - Display priority score, SLA badge (green/yellow/red), time since created\\n  - Add bulk actions: assign to me, mark in review\\n  - Implement keyboard navigation for power users\\n  - Add \\\"claim\\\" button to self-assign quotes\\n- Acceptance Criteria:\\n  - Overdue quotes visually prominent (red indicator)\\n  - Filters persist in URL for bookmarking\\n  - Real-time updates via polling or Supabase realtime\\n\\n#### Task 2.4: Quote Assignment System\\n- Location: `supabase/migrations/017_quote_assignment.sql`, `app/api/admin/quotes/[id]/assign/route.ts`\\n- Description: Allow admins to claim/assign quotes.\\n- Estimated Tokens: 600\\n- Dependencies: Task 2.3\\n- Steps:\\n  - Add `assignee_id uuid FK profiles`, `assigned_at timestamptz` to quotes\\n  - Create API endpoint for assignment with audit logging\\n  - Update queue to show assignee avatar/name\\n  - Add \\\"unassigned\\\" filter option\\n- Acceptance Criteria:\\n  - Only one assignee per quote\\n  - Assignment creates audit log entry\\n  - Reassignment allowed with reason\\n\\n### Phase 3: Customer Status & Acceptance Flow\\n**Goal**: Enable customers to view quote status and accept/reject via secure tokenized links.\\n\\n#### Task 3.1: Token Generation Service\\n- Location: `lib/quotes/tokens.ts` (new)\\n- Description: Create/validate/expire quote access tokens.\\n- Estimated Tokens: 500\\n- Dependencies: Phase 1\\n- Steps:\\n  - `createStatusToken(quoteId)` → 32-char random token, 30-day expiry\\n  - `createAcceptToken(quoteId)` → 32-char token, expires with quote validity\\n  - `validateToken(token, type)` → returns quote or null\\n  - `revokeToken(tokenId)` for invalidation\\n  - Use crypto.randomBytes for token generation\\n- Acceptance Criteria:\\n  - Tokens cryptographically random\\n  - Expired tokens return null\\n  - Used accept tokens cannot be reused\\n\\n#### Task 3.2: Public Quote Status Page\\n- Location: `app/quote/status/[token]/page.tsx` (new)\\n- Description: Customer-facing quote status view.\\n- Estimated Tokens: 1000\\n- Dependencies: Task 3.1\\n- Steps:\\n  - Server component fetching quote via token\\n  - Display: status badge, pricing breakdown (if quoted), validity countdown, company info (redacted email)\\n  - Show timeline of status changes (from audit log, sanitized)\\n  - If status=quoted: show accept/reject buttons linking to accept page\\n  - If expired: show \\\"request new quote\\\" CTA\\n  - No authentication required; token is auth\\n- Acceptance Criteria:\\n  - Invalid token shows 404-style message (not \\\"invalid token\\\" to prevent enumeration)\\n  - No sensitive internal data exposed (no admin notes, lead scores)\\n  - Mobile responsive\\n\\n#### Task 3.3: Quote Acceptance Page\\n- Location: `app/quote/accept/[token]/page.tsx` (new)\\n- Description: Form for customer to accept or reject quote with confirmation.\\n- Estimated Tokens: 1000\\n- Dependencies: Task 3.2\\n- Steps:\\n  - Validate accept-type token\\n  - Display quote summary and pricing breakdown\\n  - Accept flow: checkbox for terms, digital signature (typed name + timestamp), submit\\n  - Reject flow: optional reason dropdown + text, submit\\n  - POST to `/api/quote/accept` with token\\n  - Success page with next steps (expect email, booking process)\\n- Acceptance Criteria:\\n  - Cannot accept expired quote\\n  - Acceptance requires explicit checkbox + name\\n  - Rejection reason stored in quote record\\n\\n#### Task 3.4: Quote Accept/Reject API\\n- Location: `app/api/quote/accept/route.ts` (new)\\n- Description: Process customer acceptance or rejection.\\n- Estimated Tokens: 700\\n- Dependencies: Task 3.3\\n- Steps:\\n  - Validate token, check quote status=quoted and not expired\\n  - For accept: update status=accepted, accepted_at=now(), store signature data in metadata, mark token used\\n  - For reject: update status=rejected, rejection_reason, rejected_at\\n  - Create audit log entry with customer actor_type\\n  - Trigger notifications (Phase 4)\\n  - Return success with confirmation number\\n- Acceptance Criteria:\\n  - Race condition safe (use transaction)\\n  - Audit log captures IP address\\n  - Idempotent: re-accept returns existing confirmation\\n\\n### Phase 4: Notifications & Pricing\\n**Goal**: Implement email/Slack notifications and pricing breakdown display.\\n\\n#### Task 4.1: Email Templates\\n- Location: `lib/emails/templates/` (new directory), using Resend\\n- Description: Create email templates for quote lifecycle.\\n- Estimated Tokens: 1000\\n- Dependencies: Phase 3\\n- Steps:\\n  - `quote-received.tsx`: confirmation with tracking link (status token URL)\\n  - `quote-ready.tsx`: pricing summary, accept link (accept token URL), validity period\\n  - `quote-accepted.tsx`: confirmation, next steps\\n  - `quote-expiring.tsx`: 24h warning with accept link\\n  - `quote-expired.tsx`: invite to request new quote\\n  - Use React Email for templating, consistent branding\\n- Acceptance Criteria:\\n  - All emails mobile responsive\\n  - Links use NEXT_PUBLIC_SITE_URL for correct domain\\n  - Unsubscribe not needed (transactional)\\n\\n#### Task 4.2: Email Notification Service\\n- Location: `lib/notifications/email.ts` (new)\\n- Description: Centralized email sending with template selection.\\n- Estimated Tokens: 600\\n- Dependencies: Task 4.1\\n- Steps:\\n  - `sendQuoteEmail(type, quote, tokens)` → sends appropriate template via Resend\\n  - Log email sends to audit log\\n  - Handle Resend errors gracefully with retry logic\\n  - Rate limit: max 3 emails per quote per hour (prevent loops)\\n- Acceptance Criteria:\\n  - Failed sends logged but don't crash\\n  - Audit trail includes email send events\\n\\n#### Task 4.3: Slack Notification Updates\\n- Location: `lib/notifications/slack.ts` (modify existing or new)\\n- Description: Enhanced Slack alerts for admin queue.\\n- Estimated Tokens: 500\\n- Dependencies: Phase 2\\n- Steps:\\n  - Alert on: new high-priority quote, SLA breach (quote pending >4h), quote accepted\\n  - Include deep link to admin quote detail\\n  - Format with blocks: priority badge, customer info, quick action buttons\\n  - Respect existing Slack webhook configuration\\n- Acceptance Criteria:\\n  - Slack alerts only if webhook configured\\n  - No duplicate alerts for same event\\n\\n#### Task 4.4: Pricing Breakdown Component\\n- Location: `components/quote/pricing-breakdown.tsx` (new)\\n- Description: Display itemized pricing for quotes.\\n- Estimated Tokens: 600\\n- Dependencies: Phase 1 (pricing_breakdown JSONB)\\n- Steps:\\n  - Accept `breakdown: { items: [{name, quantity, unit_price, total}], subtotal, fees: [], taxes: [], total }`\\n  - Render table with line items, subtotals, total\\n  - Support optional notes per line item\\n  - Responsive design for mobile\\n- Acceptance Criteria:\\n  - Handles empty breakdown gracefully\\n  - Currency formatting consistent\\n  - Accessible table markup\\n\\n#### Task 4.5: Admin Pricing Entry UI\\n- Location: `app/admin/quotes/[id]/quote-actions.tsx` (modify)\\n- Description: Allow admins to enter/edit pricing breakdown when creating quote.\\n- Estimated Tokens: 800\\n- Dependencies: Task 4.4\\n- Steps:\\n  - Add \\\"Create Quote\\\" action that transitions pending→quoted\\n  - Form for pricing breakdown: add line items, set validity period\\n  - Preview mode showing customer view\\n  - Save triggers: update quote, generate accept token, send quote-ready email\\n  - Validation: total must be positive, at least one line item\\n- Acceptance Criteria:\\n  - Cannot quote without pricing\\n  - Saving auto-triggers customer notification\\n  - Audit log captures pricing changes\\n\\n### Phase 5: Metrics & Expiration\\n**Goal**: Track quote funnel metrics and handle automated expiration.\\n\\n#### Task 5.1: Quote Metrics Schema\\n- Location: `supabase/migrations/018_quote_metrics.sql`\\n- Description: Add computed metrics and aggregation support.\\n- Estimated Tokens: 500\\n- Dependencies: Phase 1\\n- Steps:\\n  - Create view `quote_metrics_daily` aggregating: quotes_received, quotes_sent, accepted, rejected, expired, avg_response_time, conversion_rate by day\\n  - Add columns to quotes: `first_response_at timestamptz`, `response_time_hours numeric`\\n  - Create function to update response_time on status change to quoted\\n- Acceptance Criteria:\\n  - View queryable for date ranges\\n  - Response time calculated correctly\\n\\n#### Task 5.2: Admin Analytics Dashboard\\n- Location: `app/admin/quotes/analytics/page.tsx` (new)\\n- Description: Simple dashboard showing quote funnel metrics.\\n- Estimated Tokens: 800\\n- Dependencies: Task 5.1\\n- Steps:\\n  - Cards: quotes this week, conversion rate, avg response time, SLA compliance %\\n  - Simple line chart: quotes over time (use existing charting lib or lightweight option)\\n  - Table: top reasons for rejection\\n  - Date range filter\\n- Acceptance Criteria:\\n  - Loads in <2s\\n  - Data refreshes on navigation\\n\\n#### Task 5.3: Automated Expiration Job\\n- Location: `app/api/cron/quote-expiration/route.ts` (new)\\n- Description: Daily job to expire old quotes and send warnings.\\n- Estimated Tokens: 600\\n- Dependencies: Phase 4\\n- Steps:\\n  - Vercel cron or manual trigger endpoint with secret\\n  - Find quotes: status=quoted AND expires_at < now() → update to expired\\n  - Find quotes: status=quoted AND expires_at < now()+24h AND no warning sent → send expiring email\\n  - Track warning_sent_at to prevent duplicates\\n  - Batch process max 100 per run\\n- Acceptance Criteria:\\n  - Idempotent: safe to run multiple times\\n  - Handles empty result sets\\n  - Logs processed count\\n\\n#### Task 5.4: Quote Validity Extension\\n- Location: `app/api/admin/quotes/[id]/extend/route.ts` (new)\\n- Description: Allow admin to extend quote validity.\\n- Estimated Tokens: 400\\n- Dependencies: Task 5.3\\n- Steps:\\n  - Accept new validity_days, update expires_at\\n  - Regenerate accept token with new expiry\\n  - Send updated quote email to customer\\n  - Audit log the extension\\n- Acceptance Criteria:\\n  - Cannot extend rejected/cancelled quotes\\n  - Customer receives notification of extension\\n\\n## Testing Strategy\\n- Unit tests: priority scoring, token generation/validation, SLA calculation\\n- Integration tests: quote lifecycle state machine (pending→quoted→accepted), token access control\\n- API tests: admin queue filters, accept/reject endpoints, expiration job\\n- E2E tests: customer flow from status page to acceptance, admin flow from queue to quoting\\n- Security tests: token enumeration resistance (invalid tokens return same response time), expired token rejection, SQL injection on filters\\n- Load test: admin queue with 1000+ quotes, concurrent acceptance attempts\\n\\n## Risks\\n- **Token security**: Brute-force token guessing → Mitigation: 32-char tokens = 10^38 combinations, rate limit token validation endpoint\\n- **Email deliverability**: Emails marked spam → Mitigation: use Resend best practices, monitor bounce rates, include text version\\n- **Race conditions**: Concurrent accept/reject → Mitigation: database transaction with row lock on quote\\n- **Migration data loss**: Schema change breaks existing data → Mitigation: backup before migration, test on staging first, all new columns nullable or have defaults\\n- **Self-critique: Pricing breakdown structure undefined**: The JSONB schema for pricing_breakdown is not formally validated; malformed data could break UI. Mitigation: Add Zod schema validation on write, defensive rendering on read.\\n- **Self-critique: Expiration timezone handling**: expires_at stored as timestamptz but customer sees \\\"expires in X days\\\" which could be off by a day depending on their timezone. Mitigation: Store and display with explicit timezone or use date-only for validity, show \\\"expires on DATE\\\" not relative time.\\n- **Self-critique: No cancel/revoke flow**: Plan lacks ability for admin to cancel a sent quote or customer to cancel acceptance. May need Task 3.5 for this.\\n- **Self-critique: Slack notification overload**: High-volume periods could spam Slack channel. Mitigation: Add batching/digest option for Slack alerts.\\n\\n## Rollback Plan\\n- Each phase has independent migration; can revert via `supabase migration repair` + manual rollback SQL\\n- Feature flags: add `FEATURE_QUOTE_STATUS_PAGE=false` env var to disable new customer-facing pages without code revert\\n- Token table can be truncated without affecting core quote data\\n- Email templates: revert to simpler text emails via template switch\\n- Queue UI: keep old flat list as fallback route `/admin/quotes/legacy`\\n\\n## Edge Cases\\n- Customer clicks accept link after admin already marked quote rejected → Show \\\"quote no longer available\\\" message\\n- Customer submits acceptance but network fails before confirmation → Backend should be idempotent; re-submit works\\n- Admin creates quote but customer email bounces → Audit log shows send failure; admin can manually resend or contact customer\\n- Quote expires while customer is on acceptance page → Validate expiry server-side on submit, show expiration message\\n- Multiple admins try to claim same quote simultaneously → First write wins, second sees \\\"already assigned\\\" (use optimistic locking)\\n- Customer loses original email, requests status link again → Admin can regenerate and resend status email from quote detail page\\n\\n## Open Questions\\n- Should rejected quotes be allowed to be re-quoted (status: rejected → in_review → quoted)?\\n- What is the default quote validity period (7 days proposed, confirm with business)?\\n- Should customers be able to request quote changes/negotiation, or only accept/reject?\\n- Is there a maximum pricing breakdown line items limit for UI performance?\\n- Should Slack alerts go to a dedicated channel or existing operations channel?\",\"session_id\":\"c57d00fd-0f49-4cb6-996b-c5eb5bcc5a59\",\"total_cost_usd\":0.16563350000000002,\"usage\":{\"input_tokens\":2,\"cache_creation_input_tokens\":0,\"cache_read_input_tokens\":14037,\"output_tokens\":5173,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":0,\"ephemeral_5m_input_tokens\":0}},\"modelUsage\":{\"claude-haiku-4-5-20251001\":{\"inputTokens\":2915,\"outputTokens\":100,\"cacheReadInputTokens\":0,\"cacheCreationInputTokens\":0,\"webSearchRequests\":0,\"costUSD\":0.003415,\"contextWindow\":200000},\"claude-opus-4-5-20251101\":{\"inputTokens\":3045,\"outputTokens\":5599,\"cacheReadInputTokens\":14037,\"cacheCreationInputTokens\":0,\"webSearchRequests\":0,\"costUSD\":0.16221850000000002,\"contextWindow\":200000}},\"permission_denials\":[],\"uuid\":\"7bc151cd-49c5-497a-95e7-71e2ed259a97\"}"
    }
  ],
  "run_id": "20260123-analyze-the-current-quote-request-quote-2",
  "task_brief": "Task: Analyze the current quote request → quote response flow in this Next.js/Supabase app and produce a phased, implementation-ready plan to close the gaps described in the provided Expert Analysis. The plan should cover customer-facing status/acceptance, internal admin queue/prioritization, notifications, pricing breakdowns, and metrics/tracking.\nConstraints:\n- Plan only; do not modify code.\n- Use existing stack: Next.js App Router, Supabase, Resend, Slack; propose minimal, explicit schema changes when required.\n- Include security/privacy considerations for public status/accept links (tokenized URLs, expiration, audit trail).\n- Address Tier 1–3 improvements and identify dependencies, risks, and test/validation steps.\n- Assume current functionality is as implemented in repo files; do not invent features not in code unless proposing them as new work.\nRepo root: .\nRelevant paths:\n- README.md\n- app/quote/page.tsx\n- app/quote/quote-form.tsx\n- app/quote/thank-you/page.tsx\n- app/api/quote/route.ts\n- app/api/admin/quotes/[id]/route.ts\n- app/admin/quotes/page.tsx\n- app/admin/quotes/[id]/page.tsx\n- app/admin/quotes/[id]/quote-actions.tsx\n- app/api/track/route.ts\n- supabase/migrations/015_quote_lead_qualification.sql\n- types/database.ts\nNotes: Current flow: quote form inserts into Supabase (if configured) and sends email/Slack; admin quotes UI is a flat list + detail actions; track endpoint can show quote status via container number. Plan should extend this to a full quote status/accept flow and prioritized admin queue.",
  "timestamps": {
    "started_at": "2026-01-23T17:46:16.627395+00:00",
    "updated_at": "2026-01-23T17:50:34.032866+00:00"
  },
  "ui_deadline": ""
}